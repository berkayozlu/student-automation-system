@page "/my-profile"
@using StudentAutomation.Frontend.Models
@using StudentAutomation.Frontend.Services
@inject IApiService ApiService
@inject IAuthService AuthService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">
                            <i class="fas fa-user-circle me-2 text-primary"></i>My Profile
                        </h3>
                        <span class="badge @(userRole == "Teacher" ? "bg-info" : "bg-success")">
                            @(userRole == "Teacher" ? "Active Teacher" : "Active Student")
                        </span>
                    </div>
                </div>
                
                @if (student != null)
                {
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 text-center mb-4">
                                <div class="profile-avatar mx-auto mb-3">
                                    @student.FirstName.Substring(0, 1).ToUpper()@student.LastName.Substring(0, 1).ToUpper()
                                </div>
                                <h4 class="mb-1">@student.FirstName @student.LastName</h4>
                                <p class="text-muted mb-2">@student.Email</p>
                                <span class="badge bg-primary fs-6">@student.StudentNumber</span>
                            </div>
                            
                            <div class="col-md-8">
                                <div class="row g-3">
                                    <div class="col-sm-6">
                                        <div class="info-card">
                                            <div class="info-label">
                                                <i class="fas fa-id-card me-2"></i>Student Number
                                            </div>
                                            <div class="info-value">@student.StudentNumber</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-sm-6">
                                        <div class="info-card">
                                            <div class="info-label">
                                                <i class="fas fa-envelope me-2"></i>Email Address
                                            </div>
                                            <div class="info-value">@student.Email</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-sm-6">
                                        <div class="info-card">
                                            <div class="info-label">
                                                <i class="fas fa-phone me-2"></i>Phone Number
                                            </div>
                                            <div class="info-value">@(student.PhoneNumber ?? "Not provided")</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-sm-6">
                                        <div class="info-card">
                                            <div class="info-label">
                                                <i class="fas fa-birthday-cake me-2"></i>Date of Birth
                                            </div>
                                            <div class="info-value">@student.DateOfBirth.ToString("MMMM dd, yyyy")</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-sm-6">
                                        <div class="info-card">
                                            <div class="info-label">
                                                <i class="fas fa-building me-2"></i>Department
                                            </div>
                                            <div class="info-value">@(student.Department ?? "Not specified")</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-sm-6">
                                        <div class="info-card">
                                            <div class="info-label">
                                                <i class="fas fa-graduation-cap me-2"></i>Academic Year
                                            </div>
                                            <div class="info-value">Year @student.Year</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-12">
                                        <div class="info-card">
                                            <div class="info-label">
                                                <i class="fas fa-map-marker-alt me-2"></i>Address
                                            </div>
                                            <div class="info-value">@(student.Address ?? "Not provided")</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-sm-6">
                                        <div class="info-card">
                                            <div class="info-label">
                                                <i class="fas fa-calendar-plus me-2"></i>Enrollment Date
                                            </div>
                                            <div class="info-value">@student.EnrollmentDate.ToString("MMMM dd, yyyy")</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-sm-6">
                                        <div class="info-card">
                                            <div class="info-label">
                                                <i class="fas fa-check-circle me-2"></i>Status
                                            </div>
                                            <div class="info-value">
                                                <span class="badge @(student.IsActive ? "bg-success" : "bg-danger")">
                                                    @(student.IsActive ? "Active" : "Inactive")
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer bg-light">
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-primary w-100" @onclick="ViewMyCourses">
                                    <i class="fas fa-book me-2"></i>View My Courses
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-success w-100" @onclick="ViewMyGrades">
                                    <i class="fas fa-chart-line me-2"></i>View My Grades
                                </button>
                            </div>
                        </div>
                    </div>
                }
                else if (teacher != null)
                {
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 text-center mb-4">
                                <div class="profile-avatar mx-auto mb-3">
                                    @teacher.FirstName.Substring(0, 1).ToUpper()@teacher.LastName.Substring(0, 1).ToUpper()
                                </div>
                                <h4 class="mb-1">@teacher.FirstName @teacher.LastName</h4>
                                <p class="text-muted mb-2">@teacher.Email</p>
                                <span class="badge bg-success fs-6">@teacher.EmployeeNumber</span>
                            </div>
                            
                            <div class="col-md-8">
                                <div class="row g-3">
                                    <div class="col-sm-6">
                                        <div class="info-card">
                                            <div class="info-label">
                                                <i class="fas fa-id-badge me-2"></i>Employee Number
                                            </div>
                                            <div class="info-value">@teacher.EmployeeNumber</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-sm-6">
                                        <div class="info-card">
                                            <div class="info-label">
                                                <i class="fas fa-envelope me-2"></i>Email Address
                                            </div>
                                            <div class="info-value">@teacher.Email</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-sm-6">
                                        <div class="info-card">
                                            <div class="info-label">
                                                <i class="fas fa-phone me-2"></i>Phone Number
                                            </div>
                                            <div class="info-value">@(teacher.PhoneNumber ?? "Not provided")</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-sm-6">
                                        <div class="info-card">
                                            <div class="info-label">
                                                <i class="fas fa-birthday-cake me-2"></i>Date of Birth
                                            </div>
                                            <div class="info-value">@teacher.DateOfBirth.ToString("MMMM dd, yyyy")</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-sm-6">
                                        <div class="info-card">
                                            <div class="info-label">
                                                <i class="fas fa-building me-2"></i>Department
                                            </div>
                                            <div class="info-value">@(teacher.Department ?? "Not specified")</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-sm-6">
                                        <div class="info-card">
                                            <div class="info-label">
                                                <i class="fas fa-user-tie me-2"></i>Title
                                            </div>
                                            <div class="info-value">@(teacher.Title ?? "Not specified")</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-12">
                                        <div class="info-card">
                                            <div class="info-label">
                                                <i class="fas fa-map-marker-alt me-2"></i>Address
                                            </div>
                                            <div class="info-value">@(teacher.Address ?? "Not provided")</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-sm-6">
                                        <div class="info-card">
                                            <div class="info-label">
                                                <i class="fas fa-calendar-plus me-2"></i>Hire Date
                                            </div>
                                            <div class="info-value">@teacher.HireDate.ToString("MMMM dd, yyyy")</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-sm-6">
                                        <div class="info-card">
                                            <div class="info-label">
                                                <i class="fas fa-check-circle me-2"></i>Status
                                            </div>
                                            <div class="info-value">
                                                <span class="badge @(teacher.IsActive ? "bg-success" : "bg-danger")">
                                                    @(teacher.IsActive ? "Active" : "Inactive")
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer bg-light">
                        <div class="row">
                            <div class="col-md-12">
                                <button class="btn btn-primary w-100" @onclick="ViewMyCourses">
                                    <i class="fas fa-chalkboard-teacher me-2"></i>View My Courses
                                </button>
                            </div>
                        </div>
                    </div>
                }
                else if (isLoading)
                {
                    <div class="card-body text-center py-5">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted">Loading your profile...</p>
                    </div>
                }
                else
                {
                    <div class="card-body text-center py-5">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h5 class="text-muted">Unable to Load Profile</h5>
                        <p class="text-muted">There was an error loading your profile information.</p>
                        <button class="btn btn-primary" @onclick="LoadProfile">
                            <i class="fas fa-refresh me-2"></i>Try Again
                        </button>
                    </div>
                }
            </div>
            
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger mt-3" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>@errorMessage
                </div>
            }
        </div>
    </div>
</div>

<style>
    .profile-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 2.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .info-card {
        background: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
        height: 100%;
        border-left: 4px solid #007bff;
    }

    .info-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }

    .info-value {
        font-size: 1rem;
        font-weight: 500;
        color: #212529;
        word-break: break-word;
    }

    .card {
        border-radius: 1rem;
        overflow: hidden;
    }

    .card-header {
        border-bottom: 1px solid #e9ecef;
        padding: 1.5rem;
    }

    .card-footer {
        border-top: 1px solid #e9ecef;
        padding: 1.5rem;
    }

    .btn {
        border-radius: 0.5rem;
        font-weight: 500;
        padding: 0.75rem 1.5rem;
    }

    .badge {
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
    }

    @@media (max-width: 768px) {
        .profile-avatar {
            width: 100px;
            height: 100px;
            font-size: 2rem;
        }
        
        .card-footer .btn {
            margin-bottom: 0.5rem;
        }
    }
</style>

@code {
    private StudentDto? student;
    private TeacherDto? teacher;
    private bool isLoading = true;
    private string errorMessage = "";
    private string userRole = "";

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("DEBUG: MyProfile page initialized");
        await LoadProfile();
    }

    private async Task LoadProfile()
    {
        try
        {
            isLoading = true;
            errorMessage = "";
            StateHasChanged();

            // Get user role first
            userRole = await AuthService.GetUserRoleAsync();
            Console.WriteLine($"DEBUG: User role detected: {userRole}");

            if (userRole == "Student")
            {
                Console.WriteLine("DEBUG: Loading student profile...");
                student = await ApiService.GetMyProfileAsync();
                
                if (student != null)
                {
                    Console.WriteLine($"DEBUG: Profile loaded for student: {student.FirstName} {student.LastName}");
                }
                else
                {
                    Console.WriteLine("DEBUG: No student profile data returned");
                    errorMessage = "Unable to load student profile information.";
                }
            }
            else if (userRole == "Teacher")
            {
                Console.WriteLine("DEBUG: Loading teacher profile...");
                teacher = await ApiService.GetMyTeacherProfileAsync();
                
                if (teacher != null)
                {
                    Console.WriteLine($"DEBUG: Profile loaded for teacher: {teacher.FirstName} {teacher.LastName}");
                }
                else
                {
                    Console.WriteLine("DEBUG: No teacher profile data returned");
                    errorMessage = "Unable to load teacher profile information.";
                }
            }
            else
            {
                errorMessage = "Profile not available for your user role.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"DEBUG: Error loading profile: {ex.Message}");
            errorMessage = "An error occurred while loading your profile.";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ViewMyCourses()
    {
        if (userRole == "Teacher")
        {
            Navigation.NavigateTo("/teacher-courses");
        }
        else
        {
            Navigation.NavigateTo("/my-courses");
        }
    }

    private void ViewMyGrades()
    {
        Navigation.NavigateTo("/my-grades");
    }
}
